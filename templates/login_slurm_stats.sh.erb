#/bin/bash

date=$(head -n 1 /usr/local/share/slurm_stats/slurm_stats_fairshare.txt)
fair=$(grep "${USER}|" /usr/local/share/slurm_stats/slurm_stats_fairshare.txt)
js=$(grep "${USER}," /usr/local/share/slurm_stats/slurm_stats_summary.txt)

if [ -n "$fair" ]
then
  echo ""
  echo "+---------------- Slurm Stats for ${date} -----------------------+"
  fairshare="End of Day Fairshare |"
  for i in $fair
  do
    account=$(echo ${i} | cut -d '|' -f 2)
    score=$(echo ${i} | cut -d '|' -f 3)
    fairshare="${fairshare} ${account}: ${score} |"
  done
  echo "${fairshare}"

  if [ -n "$js" ]
  then
    tot_cpu_hours=$(echo ${js} | cut -d ',' -f 2)
    ave_core_use=$(echo ${js} | cut -d ',' -f 3)
    ave_cpu_req=$(echo ${js} | cut -d ',' -f 4)
    ave_cpu_eff=$(echo ${js} | cut -d ',' -f 5)
    ave_mem_use=$(echo ${js} | cut -d ',' -f 6)
    ave_mem_req=$(echo ${js} | cut -d ',' -f 7)
    ave_mem_eff=$(echo ${js} | cut -d ',' -f 8)
    ave_time_use=$(echo ${js} | cut -d ',' -f 9)
    ave_time_req=$(echo ${js} | cut -d ',' -f 10)
    ave_time_eff=$(echo ${js} | cut -d ',' -f 11)
    ave_wait_time=$(echo ${js} | cut -d ',' -f 12)
    tot_gpu_hours=$(echo ${js} | cut -d ',' -f 13)
    ave_gpu_req=$(echo ${js} | cut -d ',' -f 14)
    ntot=$(echo ${js} | cut -d ',' -f 15)
    nca=$(echo ${js} | cut -d ',' -f 16)
    ncd=$(echo ${js} | cut -d ',' -f 17)
    nf=$(echo ${js} | cut -d ',' -f 18)
    noom=$(echo ${js} | cut -d ',' -f 19)
    nto=$(echo ${js} | cut -d ',' -f 20)
    echo "Jobs by State: ${ntot} Total | ${ncd} Completed | ${nca} Canceled | ${nf} Failed | ${noom} Out of Memory | ${nto} Timed Out"
    echo "All Values Averaged Over the Day Unless Otherwise Noted
    echo "Cores Used: ${ave_core_use} | Allocated: ${ave_cpu_req} | Efficiency: ${ave_cpu_eff}% |Total Usage: ${tot_cpu_hours} CPU Hours"
    echo "Memory Used: ${ave_mem_use}GB | Allocated: ${ave_mem_req}GB | Efficiency: ${ave_mem_eff}%"
    echo "GPUs Used: ${ave_gpu_req}" | Total Usage: ${tot_gpu_hours} GPU Hours 
    echo "Wait Time: ${ave_wait_time} hours | Run Time: ${ave_time_use} hours | Requested: ${ave_time_req} | Efficiency: ${ave_time_eff}%"
  else
    echo "No jobs completed on ${date}"
  fi
fi