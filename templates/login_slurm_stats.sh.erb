#/bin/bash

date=$(head -n 1 /usr/local/share/slurm_stats/slurm_stats_fairshare.txt)
fair=$(grep "${USER}|" /usr/local/share/slurm_stats/slurm_stats_fairshare.txt)
js=$(grep "${USER}," /usr/local/share/slurm_stats/slurm_stats_summary.txt)

if [ -n "$fair" ]
then
  echo ""
  echo "+---------------- Slurm Stats for ${date} -----------------------+"
  echo "| End of Day Fairshare                                           |" 
  for i in $fair
  do
    account=$(echo ${i} | cut -d '|' -f 2)
    score=$(echo ${i} | cut -d '|' -f 3)
    print "| %30s: %8s                           |\n" ${account} ${score}
  done

  if [ -n "$js" ]
  then
    tot_cpu_hours=$(echo ${js} | cut -d ',' -f 2)
    ave_core_use=$(echo ${js} | cut -d ',' -f 3)
    ave_cpu_req=$(echo ${js} | cut -d ',' -f 4)
    ave_cpu_eff=$(echo ${js} | cut -d ',' -f 5)
    ave_mem_use=$(echo ${js} | cut -d ',' -f 6)
    ave_mem_req=$(echo ${js} | cut -d ',' -f 7)
    ave_mem_eff=$(echo ${js} | cut -d ',' -f 8)
    ave_time_use=$(echo ${js} | cut -d ',' -f 9)
    ave_time_req=$(echo ${js} | cut -d ',' -f 10)
    ave_time_eff=$(echo ${js} | cut -d ',' -f 11)
    ave_wait_time=$(echo ${js} | cut -d ',' -f 12)
    tot_gpu_hours=$(echo ${js} | cut -d ',' -f 13)
    ave_gpu_req=$(echo ${js} | cut -d ',' -f 14)
    ntot=$(echo ${js} | cut -d ',' -f 15)
    nca=$(echo ${js} | cut -d ',' -f 16)
    ncd=$(echo ${js} | cut -d ',' -f 17)
    nf=$(echo ${js} | cut -d ',' -f 18)
    noom=$(echo ${js} | cut -d ',' -f 19)
    nto=$(echo ${js} | cut -d ',' -f 20)
    echo "+---------------- Slurm Stats for Aug 19 -----------------------+"
    echo "+-------------------- Jobs By State ----------------------------+"
    echo "| Total | Completed | Canceled | Failed | Out of Memory | Timed Out |"
    printf "| %6d | %6d | %6d | %6d | %6d | %6d |\n" ${ntot} ${ncd} ${nca} ${nf} ${noom} ${nto}
    echo "+---------------------- Job Stats ------------------------------+"
    echo "|     | Average | Average   | Average           | Total Usage /     |"
    echo "|     | Used    | Allocated | Efficiency        | Ave. Wait Time    |"
    printf "| Cores  | %6s | %6s | %6s \% | %6s CPU Hours |\n" ${ave_core_use} ${ave_cpu_req} ${ave_cpu_eff} ${tot_cpu_hours}
    printf "| Memory | %6s GB | %6s GB | %6s \% |       |\n" ${ave_mem_use} ${ave_mem_req} ${ave_mem_eff}
    printf "| GPUS   |    | %6s |    | %6s GPU Hours      |\n" ${ave_gpu_req} ${tot_gpu_hours} 
    printf "| Time   | %6s hrs | %6s hrs | %6s \% | Wait Time: %6s |\n" ${ave_time_use} ${ave_time_req} ${ave_time_eff} ${ave_wait_time}
    echo "+---------------------------------------------------------------+"
  else
    echo "+--------------- No jobs completed on ${date} ------------------+"
  fi
fi

